<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>WeatherResponseCache.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">s0</a> &gt; <a href="index.source.html" class="el_package">server</a> &gt; <span class="el_source">WeatherResponseCache.java</span></div><h1>WeatherResponseCache.java</h1><pre class="source lang-java linenums">package server;

import com.google.common.cache.CacheBuilder;
import com.google.common.cache.CacheLoader;
import com.google.common.cache.LoadingCache;
import java.util.List;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.TimeUnit;

/** This will be the class implements caching! */
public class WeatherResponseCache {
  // the guava LoadingCache - keys are [lat, long], values are [temp, unit]
  public LoadingCache&lt;List&lt;Float&gt;, List&lt;String&gt;&gt; cache;
  // maximum distance which can be considered &quot;close enough&quot; for cached results
  // to be returned (positive int in miles)
  int maxDistance;

  /**
   * Constructor for our WeatherResponseCache class!
   *
   * @param maxSize - maxSize of our cache
   * @param evictTime - evictTime of our cache
   * @param maxDistance - maxDistance of how close is &quot;close enough&quot; for cached values to be
   *     returned!
   */
<span class="nc" id="L26">  public WeatherResponseCache(int maxSize, int evictTime, int maxDistance, Loader myLoader) {</span>
<span class="nc" id="L27">    this.maxDistance = maxDistance;</span>
<span class="nc" id="L28">    this.cache =</span>
<span class="nc" id="L29">        CacheBuilder.newBuilder()</span>
<span class="nc" id="L30">            .maximumSize(maxSize) // set max size</span>
<span class="nc" id="L31">            .expireAfterWrite(evictTime, TimeUnit.MINUTES) // set eviction time</span>
<span class="nc" id="L32">            .recordStats() // record stats for ?</span>
<span class="nc" id="L33">            .build( // build!</span>
<span class="nc" id="L34">                new CacheLoader&lt;List&lt;Float&gt;, List&lt;String&gt;&gt;() {</span>
                  // key is a list of two float entries, [lat, long]
                  // value is a list of two string entries, [temp, unit]
                  @Override
                  public List&lt;String&gt; load(List&lt;Float&gt; key) throws Exception {
                    // if not yet in our cache, make a new request!
                    // remember: key is [lat, long]
<span class="nc" id="L41">                    return myLoader.loader(key.get(0), key.get(1));</span>
                  }
                });
<span class="nc" id="L44">  }</span>

  /**
   * Calculate great-circle-distance between two latitude and longitude pts
   *
   * @param lat1 - latitude 1
   * @param lon1 - longitude 1
   * @param lat2 - latitude 2
   * @param lon2 - longitude 2
   * @return distance between points!
   */
  // https://www.geeksforgeeks.org/haversine-formula-to-find-distance-between-two-points-on-a-sphere/
  public static double haversine(double lat1, double lon1, double lat2, double lon2) {
    // distance between latitudes and longitudes
<span class="nc" id="L58">    double dLat = Math.toRadians(lat2 - lat1);</span>
<span class="nc" id="L59">    double dLon = Math.toRadians(lon2 - lon1);</span>

    // convert to radians
<span class="nc" id="L62">    lat1 = Math.toRadians(lat1);</span>
<span class="nc" id="L63">    lat2 = Math.toRadians(lat2);</span>

    // apply formulae
<span class="nc" id="L66">    double a =</span>
<span class="nc" id="L67">        Math.pow(Math.sin(dLat / 2), 2)</span>
<span class="nc" id="L68">            + Math.pow(Math.sin(dLon / 2), 2) * Math.cos(lat1) * Math.cos(lat2);</span>
<span class="nc" id="L69">    double rad = 6371;</span>
<span class="nc" id="L70">    double c = 2 * Math.asin(Math.sqrt(a));</span>
<span class="nc" id="L71">    return rad * c;</span>
  }

  /**
   * Where the magic happens. Checks the cache for distance
   *
   * @param latitude1 - lat of point we are currently asking for
   * @param longitude1 - long of point we are currently asking for
   * @return [temp, unit], either from cache (if close enough) or from new request NOTE: we use
   *     .get() instead of .getUnchecked() so that we may propagate exceptions upwards when we
   *     receive a 404!
   */
  public List&lt;String&gt; checkCache(float latitude1, float longitude1) throws ExecutionException {
    // iterate through all cached entries (keys are [lat, long], values are [temp, unit])
    List&lt;String&gt; tempAndUnit;

<span class="nc bnc" id="L87" title="All 2 branches missed.">    for (List&lt;Float&gt; latLong : this.cache.asMap().keySet()) {</span>

      // grab the cached point to compare distance
<span class="nc" id="L90">      float latitude2 = latLong.get(0);</span>
<span class="nc" id="L91">      float longitude2 = latLong.get(1);</span>

      // compare distance using haversine
<span class="nc bnc" id="L94" title="All 2 branches missed.">      if (haversine(latitude1, longitude1, latitude2, longitude2) &lt; maxDistance) {</span>
        // if small enough, return cached value and indicate that we pulled
        // from cache!

<span class="nc" id="L98">        tempAndUnit = this.cache.get(latLong);</span>
<span class="nc" id="L99">        return List.of(tempAndUnit.get(0), tempAndUnit.get(1), &quot;cache&quot;);</span>
      }
<span class="nc" id="L101">    }</span>
    // if no small enough distance found, get on cache (will call API)
    // and indicate that we called api
<span class="nc" id="L104">    tempAndUnit = this.cache.get(List.of(latitude1, longitude1));</span>
<span class="nc" id="L105">    return List.of(tempAndUnit.get(0), tempAndUnit.get(1), &quot;api&quot;);</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>